<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>HybridCLR拆解记录 (Part. I)</title>
    <link href="/hybridCLR/"/>
    <url>/hybridCLR/</url>
    
    <content type="html"><![CDATA[<p>被迫造轮子但必须得手撕Asm的感觉不亚于屎里找饭，<del>这种自虐的感觉真让人欲罢不能。</del></p><span id="more"></span><p>原本在<a href="https://floeic3.github.io/coderustle2/#0x06-%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8HybridCLR-Hook%F0%9F%98%95">上一篇文章0x06</a>的尝试过后，我已经打定主意不再碰HybridCLR了，一是因为网络上可参考的内容确实不多，native hook方案非开源，<del>抄都没地方抄</del>；二是既然已经可以直接replace dll了，为啥还要自找麻烦呢？但实在是不甘心只能用Frida脚本反复试错，于是艰苦的旅程又双叒叕开始了。下文依旧围绕coderustle2展开。</p><div class="note note-info">            <p>APP: com.wingjoy.coderustle2 (ver 1.8.16)<br>OS: Redmi K40 with HyperOS 1.0.6.0 (Android 13) &#x2F; Xiaomi 14 with HyperOS 3.0.6.0 (Android 16)<br>Tools: Android Studio &#x2F; NDK r27 &#x2F; SDK 36.0</p>          </div><h2 id="函数进入监听及入参修改"><a href="#函数进入监听及入参修改" class="headerlink" title="函数进入监听及入参修改"></a>函数进入监听及入参修改</h2><h3 id="0x00-原理分析"><a href="#0x00-原理分析" class="headerlink" title="0x00 原理分析"></a>0x00 原理分析</h3><div class="note note-warning">            <p>额外说明：不同版本的HybridCLR，相关重要函数参数及结构体定义不尽相同。以下内容均基于hybridclr-4.0.0。</p>          </div><p>不赘述，根据官方文档<a href="https://www.hybridclr.cn/docs/basic/methodbridge">桥接函数</a>、<a href="https://www.hybridclr.cn/docs/basic/sourceinspect">HybridCLR源码结构及调试</a>及源码，可知<code>hybridclr/interpreter/interpreter_Execute.cpp</code>的<code>Interpreter::Execute</code>函数负责寄存器IR指令的解释执行，同时也是Native&#x2F;反射进入解释器的唯一入口；<code>hybridclr/interpreter/Engine.h</code>的<code>EnterFrameFromInterpreter</code>函数负责解释器调用解释器（即解释器内部A方法调用内部B方法）时建立 frame，不复制参数；<code>hybridclr/interpreter/Engine.h</code>的<code>EnterFrameFromNative</code>函数负责Native调用解释器时建立 frame，并把参数搬进解释器栈。上述亦参考了其他分析文章：<a href="https://bbs.kanxue.com/thread-281910.htm">UnityHybirdCLR Hook实现</a>、<a href="https://frog-game.github.io/posts/read/hybridclr-yuanmayuedu/#%e4%b8%80%e4%ba%9b%e5%89%8d%e6%8f%90%e7%9f%a5%e8%af%86%e7%82%b9">HybridCLR源码赏析</a></p><p>结论显而易见，同时hook <code>EnterFrameFromNative</code>和<code>EnterFrameFromInterpreter</code>函数，根据第一个参数<code>InterpMethodInfo* imi</code>结构体定义，通过解析可获得<code>MethodInfo* method</code>，进而拿到所有进入解释器的方法信息。<code>InterpMethodInfo</code>定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/InterpreterDefs.h</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">InterpMethodInfo</span> &#123;<br>    <span class="hljs-type">const</span> MethodInfo* method;<br>    MethodArgDesc* args;<br>    <span class="hljs-type">uint32_t</span> argCount;<br>    <span class="hljs-type">uint32_t</span> argStackObjectSize;<br>    byte* codes;<br>    <span class="hljs-type">uint32_t</span> codeLength;<br>    <span class="hljs-type">uint32_t</span> maxStackSize; <span class="hljs-comment">// args + locals + evalstack size</span><br>    <span class="hljs-type">uint32_t</span> localVarBaseOffset;<br>    <span class="hljs-type">uint32_t</span> evalStackBaseOffset;<br>    <span class="hljs-type">uint32_t</span> localStackSize; <span class="hljs-comment">// args + locals StackObject size</span><br>    std::vector&lt;<span class="hljs-type">uint64_t</span>&gt; resolveDatas;<br>    std::vector&lt;InterpExceptionClause*&gt; exClauses;<br>    <span class="hljs-type">bool</span> initLocals;<br>&#125;;<br></code></pre></td></tr></table></figure><p>第二个参数<code>StackObject* argBase</code>中的<code>StackObject</code>本身并不是数据类型，而是作为解释器栈槽（stack slot），同时声明解释器的最小栈单位是8字节。每个参数、局部变量、临时值都可能占用 1个或多个<code>StackObject</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/InterpreterDefs.h</span><br><span class="hljs-keyword">union</span> <span class="hljs-title class_">StackObject</span> &#123;<br>    <span class="hljs-type">uint64_t</span> __u64;<br>    <span class="hljs-type">void</span>* ptr;<br>    <span class="hljs-type">bool</span> b;<br>    <span class="hljs-type">int8_t</span> i8;<br>    <span class="hljs-type">uint8_t</span> u8;<br>    <span class="hljs-type">int16_t</span> i16;<br>    <span class="hljs-type">uint16_t</span> u16;<br>    <span class="hljs-type">int32_t</span> i32;<br>    <span class="hljs-type">uint32_t</span> u32;<br>    <span class="hljs-type">int64_t</span> i64;<br>    <span class="hljs-type">uint64_t</span> u64;<br>    <span class="hljs-type">float</span> f4;<br>    <span class="hljs-type">double</span> f8;<br>    Il2CppObject* obj;<br>    Il2CppString* str;<br>    Il2CppObject** ptrObj;<br>&#125;;<br><span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(StackObject) == <span class="hljs-number">8</span>, <span class="hljs-string">&quot;require 8 bytes&quot;</span>);<br></code></pre></td></tr></table></figure><p>其中<strong>bool&#x2F;int8&#x2F;int16&#x2F;int32&#x2F;float</strong>类型实际只用slot低位，高位清零，但仍占用8字节槽；<strong>int64&#x2F;double&#x2F;指针</strong>类型正好占满8字节；<strong>Struct</strong>类型将按大小拆成多个StackObject，如：12字节 -&gt; 8字节+4字节 -&gt; 2个slot。对于简单的入参类型，如<code>int A</code>，可以直接按上述定义读取值，例：<code>int valueA = argBase[i].i32</code>；写回值时要注意不要混用成员，同理：<code>argBase[i].i32 = newValue</code>；针对值传递结构体，取值时应按结构体大小，把连续的<code>StackObject</code>视同一块原始内存来读：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span>* value = <span class="hljs-built_in">reinterpret_cast</span>&lt;Struct*&gt;(&amp;argBase[start]);<br>Struct v = *value;<br><span class="hljs-type">float</span> f = value-&gt;someField;  <span class="hljs-comment">// 也可只读字段</span><br></code></pre></td></tr></table></figure><p>写回时直接按内存拷贝：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span>* dst = <span class="hljs-built_in">reinterpret_cast</span>&lt;Struct*&gt;(&amp;argBase[start]);<br>*dst = newValue;<br></code></pre></td></tr></table></figure><p>针对ref&#x2F;out（引用传递&#x2F;输出引用）结构体，栈上只放了1个指向真实Struct地址的指针，读写方式需要对应修改：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">auto</span>* p = <span class="hljs-built_in">reinterpret_cast</span>&lt;Struct*&gt;(argBase[i].ptr);  <span class="hljs-comment">// 读</span><br>p-&gt;field = value;  <span class="hljs-comment">// 写</span><br>*p = newValue;  <span class="hljs-comment">// 写</span><br></code></pre></td></tr></table></figure><h3 id="0x01-函数进入监听"><a href="#0x01-函数进入监听" class="headerlink" title="0x01 函数进入监听"></a>0x01 函数进入监听</h3><p>获得<code>EnterFrameFromNative</code>和<code>EnterFrameFromInterpreter</code>函数绝对地址的方法可参考<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook">HybridCLR-Hook</a>，此处不赘述。基于Dobby的hook写法示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//0xF5D7C4 InterpFrame* EnterFrameFromNative(const InterpMethodInfo* imi, StackObject* argBase)</span><br><span class="hljs-comment">//0xF5D8E0 InterpFrame* EnterFrameFromInterpreter(const InterpMethodInfo* imi, StackObject* argBase)</span><br><span class="hljs-built_in">HOOK_DEF</span>(InterpFrame*, EnterFrameFromInterpreter, InterpFrame* self, <span class="hljs-type">const</span> InterpMethodInfo* imi, StackObject* argBase) &#123;<br>    InterpFrame* newFrame = <span class="hljs-built_in">orig_EnterFrameFromInterpreter</span>(self, imi, argBase);<br>    <span class="hljs-type">const</span> MethodInfo* method = imi-&gt;method;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = method-&gt;name;<br>    <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;[Interp] %s called&quot;</span>, name);<br>    <span class="hljs-keyword">return</span> newFrame;<br>&#125;<br><span class="hljs-comment">// Use absolute address for test</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doHook</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">//HOOK_FUNC((il2cpp_base + 0xF5D7C4), EnterFrameFromNative);</span><br>    <span class="hljs-built_in">HOOK_FUNC</span>((il2cpp_base + <span class="hljs-number">0xF5D8E0</span>), EnterFrameFromInterpreter);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x02-入参修改"><a href="#0x02-入参修改" class="headerlink" title="0x02 入参修改"></a>0x02 入参修改</h3><p>函数原型：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// Token: 0x06000694 RID: 1684 RVA: 0x000260EC File Offset: 0x000242EC</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddDropGoldCoins</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span> &#123;<br><span class="hljs-keyword">this</span>.m_TotalGoldCoins += count;<br>&#125;<br></code></pre></td></tr></table></figure><p>hook示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">HOOK_DEF</span>(InterpFrame*, EnterFrameFromInterpreter, InterpFrame* self, <span class="hljs-type">const</span> InterpMethodInfo* imi, StackObject* argBase) &#123;<br>    <span class="hljs-type">const</span> MethodInfo* method = imi-&gt;method;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = method-&gt;name;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;AddDropGoldCoins&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">int</span> count = argBase[<span class="hljs-number">1</span>].i32;<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;[Interp] orig count： %d&quot;</span>, count);<br>        argBase[<span class="hljs-number">1</span>].i32 = count * <span class="hljs-number">50</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">orig_EnterFrameFromInterpreter</span>(self, imi, argBase);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="函数返回值读取及修改"><a href="#函数返回值读取及修改" class="headerlink" title="函数返回值读取及修改"></a>函数返回值读取及修改</h2><h4 id="0x03-原理分析"><a href="#0x03-原理分析" class="headerlink" title="0x03 原理分析"></a>0x03 原理分析</h4><p>首先查看<code>hybridclr/interpreter/Engine.h</code>的<code>LeaveFrame</code>函数，逐行解读：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/Engine.h</span><br><span class="hljs-function">InterpFrame* <span class="hljs-title">LeaveFrame</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-built_in">IL2CPP_ASSERT</span>(_machineState.<span class="hljs-built_in">GetFrameTopIdx</span>() &gt; _frameBaseIdx);  <span class="hljs-comment">// 断言当前至少存在一个可弹出的解释器帧，防止栈下溢</span><br><span class="hljs-built_in">POP_STACK_FRAME</span>();  <span class="hljs-comment">// 通知调试器/profiler当前方法即将退出</span><br>InterpFrame* frame = _machineState.<span class="hljs-built_in">GetTopFrame</span>();  <span class="hljs-comment">// 取得当前正在执行的callee帧</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> IL2CPP_ENABLE_PROFILER</span><br><span class="hljs-built_in">il2cpp_codegen_profiler_method_exit</span>(frame-&gt;method-&gt;method);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">if</span> (frame-&gt;exFlowBase) &#123;  <span class="hljs-comment">// 如果该方法内部使用过异常处理（try/catch）</span><br>_machineState.<span class="hljs-built_in">SetExceptionFlowTop</span>(frame-&gt;exFlowBase);  <span class="hljs-comment">// 恢复异常流栈到进入该方法之前的状态，防止异常信息泄漏到caller帧</span><br>&#125;<br>_machineState.<span class="hljs-built_in">PopFrame</span>();  <span class="hljs-comment">// 将当前callee Frame从frame栈中移除</span><br>_machineState.<span class="hljs-built_in">SetStackTop</span>(frame-&gt;oldStackTop);  <span class="hljs-comment">// 恢复解释器操作数栈到进入该方法之前的高度</span><br>_machineState.<span class="hljs-built_in">SetLocalPoolBottomIdx</span>(frame-&gt;oldLocalPoolBottomIdx);<br><span class="hljs-keyword">return</span> _machineState.<span class="hljs-built_in">GetFrameTopIdx</span>() &gt; _frameBaseIdx ? _machineState.<span class="hljs-built_in">GetTopFrame</span>() : <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 如果还有上层帧，则返回caller的InterpFrame*；如果已经回到解释器入口，则返回nullptr，解释器执行结束</span><br>&#125;<br></code></pre></td></tr></table></figure><p>进一步查找<code>LeaveFrame</code>函数于何处被使用，进入到<code>hybridclr/interpreter/interpreter_Execute.cpp</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/interpreter_Execute.cpp</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAVE_FRAME() &#123; \</span><br><span class="hljs-meta">frame = interpFrameGroup.LeaveFrame(); \  <span class="hljs-comment">// 弹出当前解释器帧返回caller帧，或nullptr</span></span><br><span class="hljs-keyword">if</span> (frame) \                              <span class="hljs-comment">// 如果为解释器内部调用返回（interp -&gt; interp）</span><br>&#123; \<br><span class="hljs-built_in">LOAD_PREV_FRAME</span>(); \                  <span class="hljs-comment">// 恢复caller帧的执行上下文，继续解释执行</span><br>&#125;\<br><span class="hljs-keyword">else</span> \                                    <span class="hljs-comment">// 最外层返回（interp -&gt; native）</span><br>&#123; \<br><span class="hljs-keyword">goto</span> ExitEvalLoop; \                  <span class="hljs-comment">// 跳出解释器主循环</span><br>&#125; \<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SET_RET_AND_LEAVE_FRAME(nativeSize, interpSize) &#123; \</span><br><span class="hljs-meta">void* _curRet = frame-&gt;ret; \                                   <span class="hljs-comment">// 保存当前帧的返回值地址</span></span><br>frame = interpFrameGroup.<span class="hljs-built_in">LeaveFrame</span>(); \                        <span class="hljs-comment">// 弹出当前解释器帧并返回caller帧，或nullptr</span><br><span class="hljs-keyword">if</span> (frame) \                                                    <span class="hljs-comment">// 如果为解释器内部调用返回（interp -&gt; interp）</span><br>&#123; \<br>        Copy##<span class="hljs-built_in">interpSize</span>(_curRet, (<span class="hljs-type">void</span>*)(localVarBase + __ret)); \ <span class="hljs-comment">// 使用解释器格式（StackObject）拷贝callee帧的返回值到_curRet，供caller帧读取</span><br><span class="hljs-built_in">LOAD_PREV_FRAME</span>(); \                                        <span class="hljs-comment">// 恢复caller帧的执行上下文，继续解释执行</span><br>&#125;\<br><span class="hljs-keyword">else</span> \                                                          <span class="hljs-comment">// 最外层返回（interp -&gt; native）,如：Runtime::Invoke</span><br>&#123; \<br>        Copy##<span class="hljs-built_in">nativeSize</span>(_curRet, (<span class="hljs-type">void</span>*)(localVarBase + __ret)); \ <span class="hljs-comment">// 使用native ABI约定拷贝返回值</span><br><span class="hljs-keyword">goto</span> ExitEvalLoop; \                                        <span class="hljs-comment">// 跳出解释器主循环</span><br>&#125; \<br>&#125;<br></code></pre></td></tr></table></figure><p>可见此处定义了2个预处理宏，其中<code>LEAVE_FRAME()</code>用于在执行循环中弹出当前解释器帧，恢复上一帧上下文或在没有帧可返回时跳出解释器主循环，执行完毕后销毁当前帧；<code>SET_RET_AND_LEAVE_FRAME(nativeSize, interpSize)</code>用于处理有返回值的方法，这里我们结合<code>Execute</code>函数中的特定case以及<code>Copy##</code>函数源码重新阅读一遍，以<code>case RetVar_ret_1</code>为例：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/interpreter_Execute.cpp</span><br><span class="hljs-keyword">case</span> HiOpcodeEnum::RetVar_ret_1: &#123;          <span class="hljs-comment">// 若返回值为1字节</span><br><span class="hljs-type">uint16_t</span> __ret = *(<span class="hljs-type">uint16_t</span>*)(ip + <span class="hljs-number">2</span>);  <span class="hljs-comment">// 从当前解释器指令后2个字节中取uint16_t作为__ret，作为返回值的局部变量索引</span><br><span class="hljs-built_in">SET_RET_AND_LEAVE_FRAME</span>(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>);          <span class="hljs-comment">// 将返回值从localVarBase的ret slot拷贝到caller帧的ret slot，供caller读取</span><br><span class="hljs-keyword">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/MemoryUtil.h</span><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Copy1</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst, <span class="hljs-type">void</span>* src)</span> </span>&#123;  <span class="hljs-comment">// 如果最外层返回至native，遵循ABI按真实类型大小进行拷贝，即Copy1</span><br>*(<span class="hljs-type">uint8_t</span>*)dst = *(<span class="hljs-type">uint8_t</span>*)src;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Copy8</span><span class="hljs-params">(<span class="hljs-type">void</span>* dst, <span class="hljs-type">void</span>* src)</span> </span>&#123;  <span class="hljs-comment">// 如果解释器内部调用返回，执行Copy8，最终返回1个StackObject（8字节）</span><br>*(<span class="hljs-type">uint64_t</span>*)dst = *(<span class="hljs-type">uint64_t</span>*)src;<br>&#125;<br></code></pre></td></tr></table></figure><p>那么，如果想要读取或者修改函数返回值，<strong>最稳妥的载点应该是<code>Copy</code>函数执行之前，对<code>localVarBase + __ret</code>指向的内存区域进行读写</strong>。但还有1个关键问题待确认：<code>Copy</code>执行之前，<code>LeaveFrame</code>已经执行完毕，在这中间阶段寄存器中是否还留存有<code>InterpFrame* callee</code>？相关信息是否已经被<code>LeaveFrame</code>销毁？这关乎到我们能否在此处获得callee帧method信息，以及进行特定method hook。</p><p>阅读源码<code>case RetVar_ret_n</code>，通过<code>memove</code>交叉引用定位到<code>LeaveFrame()</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/interpreter_Execute.cpp</span><br><span class="hljs-keyword">case</span> HiOpcodeEnum::RetVar_ret_n: &#123;<br><span class="hljs-type">uint16_t</span> __ret = *(<span class="hljs-type">uint16_t</span>*)(ip + <span class="hljs-number">2</span>);<br><span class="hljs-type">uint32_t</span> __size = *(<span class="hljs-type">uint32_t</span>*)(ip + <span class="hljs-number">4</span>);<br>std::<span class="hljs-built_in">memmove</span>(frame-&gt;ret, (<span class="hljs-type">void</span>*)(localVarBase + __ret), __size);<br><span class="hljs-built_in">LEAVE_FRAME</span>();<br><span class="hljs-keyword">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>对应：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">loc_F52F24:</span>                              <br><span class="hljs-keyword">LDRH</span> <span class="hljs-built_in">W8</span>, [<span class="hljs-built_in">X22</span>,<span class="hljs-number">#2</span>]                 <span class="hljs-comment">; jumptable 0000000000F4AAC0 case 294</span><br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W2</span>, [<span class="hljs-built_in">X22</span>,<span class="hljs-number">#4</span>]                  <span class="hljs-comment">; size_t</span><br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X0</span>, [<span class="hljs-built_in">X25</span>,<span class="hljs-number">#0x18</span>]               <span class="hljs-comment">; void *</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X1</span>, <span class="hljs-built_in">X23</span>, <span class="hljs-built_in">X8</span>,LSL<span class="hljs-number">#3</span>             <span class="hljs-comment">; void *</span><br><span class="hljs-keyword">BL</span> .memmove<br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X0</span>, <span class="hljs-built_in">SP</span>, <span class="hljs-number">#0x1460</span>+var_BF0<br><span class="hljs-keyword">BL</span> LeaveFrame                     <span class="hljs-comment">; sub_F5D954</span><br><span class="hljs-keyword">B</span> loc_F5445C<br></code></pre></td></tr></table></figure><p><code>Execute</code>共计调用<code>LeaveFrame</code>16次，与IDA所查看的交叉引用次数相符。此处画一个流程图便于理解：</p><p><img src="/img/hybridCLR/0x03-1.png"></p><p>顺带根据Copy的系列定义，对比Asm语义逐一标注出<code>SET_RET_AND_LEAVE_FRAME(1, 8)</code>至<code>SET_RET_AND_LEAVE_FRAME(32, 32)</code>入口：</p><p><img src="/img/hybridCLR/0x03-2.png"></p><p>以<code>case RetVar_ret_24</code>为例（<code>ObscuredFloat</code>就是24字节Struct，后面接着细说），先解读入口的几句Asm：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">loc_F4B24C:</span>                       <span class="hljs-comment">; jumptable 0000000000F4AAC0 case 291 RetVar_ret_24</span><br><span class="hljs-keyword">LDRH</span> <span class="hljs-built_in">W20</span>, [<span class="hljs-built_in">X22</span>,<span class="hljs-number">#2</span>]            <span class="hljs-comment">; X22 = ip，W20 = __ret = ip + 2</span><br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X19</span>, [<span class="hljs-built_in">X25</span>,<span class="hljs-number">#0x18</span>]          <span class="hljs-comment">; X25 = InterpFrame* callee，X19 = frame-&gt;ret = dst</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X0</span>, <span class="hljs-built_in">SP</span>, <span class="hljs-number">#0x1460</span>+var_BF0   <span class="hljs-comment">; X0 = &amp;interpFrameGroup(this)</span><br><span class="hljs-keyword">BL</span> LeaveFrame<br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X23</span>, <span class="hljs-built_in">X20</span>,LSL<span class="hljs-number">#3</span>        <span class="hljs-comment">; X23 = localVarBase，X20 = __ret，X8 = src，等价于：void* src = localVarBase + __ret</span><br><span class="hljs-keyword">CMP</span> <span class="hljs-built_in">X19</span>, <span class="hljs-built_in">X8</span><br>B.HI loc_F50DCC<br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X8</span>]                  <span class="hljs-comment">; 拷贝slot0</span><br><span class="hljs-keyword">STR</span> <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X19</span>]                 <span class="hljs-comment">; 拷贝slot0</span><br><span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#8</span>]               <span class="hljs-comment">; 拷贝slot1</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-number">#0x10</span>             <span class="hljs-comment">; X8 -&gt; slot3</span><br><span class="hljs-keyword">STR</span> <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X19</span>,<span class="hljs-number">#8</span>]              <span class="hljs-comment">; 拷贝slot1</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X19</span>, <span class="hljs-built_in">X19</span>, <span class="hljs-number">#0x10</span>           <span class="hljs-comment">; X19 -&gt; slot3</span><br><span class="hljs-keyword">B</span> loc_F54454                  <span class="hljs-comment">; slot3后续拷贝</span><br></code></pre></td></tr></table></figure><p>因此，需要重点关注寄存器X25所保存的<code>InterpFrame* callee</code>在<code>LeaveFrame</code>执行完毕后是否被其他值覆盖。结合<code>MachineState</code>定义，把<code>LeaveFrame</code>的Asm读一遍：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// hybridclr/interpreter/Engine.h</span><br><span class="hljs-built_in">MachineState</span>() &#123;<br>Config&amp; hc = Config::<span class="hljs-built_in">GetIns</span>();<br>_stackSize = <span class="hljs-number">-1</span>;<br>_stackBase = <span class="hljs-literal">nullptr</span>;<br>_stackTopIdx = <span class="hljs-number">0</span>;<br>_localPoolBottomIdx = <span class="hljs-number">-1</span>;<br>_frameBase = <span class="hljs-literal">nullptr</span>;<br>_frameCount = <span class="hljs-number">-1</span>;<br>_frameTopIdx = <span class="hljs-number">0</span>;<br>_exceptionFlowBase = <span class="hljs-literal">nullptr</span>;<br>_exceptionFlowCount = <span class="hljs-number">-1</span>;<br>_exceptionFlowTopIdx = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">LeaveFrame:</span><br>    STP <span class="hljs-built_in">X20</span>, <span class="hljs-built_in">X19</span>, [<span class="hljs-built_in">SP</span>,#-<span class="hljs-number">0x10</span>]!        <span class="hljs-comment">; 保存被调用者寄存器 X19/X20</span><br>    STP <span class="hljs-built_in">X29</span>, <span class="hljs-built_in">X30</span>, [<span class="hljs-built_in">SP</span>,<span class="hljs-number">#0x10</span>]          <span class="hljs-comment">; 保存 FP/LR</span><br>    <span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X29</span>, <span class="hljs-built_in">SP</span>, <span class="hljs-number">#0x10</span>                <span class="hljs-comment">; 建立栈帧</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X0</span>]                      <span class="hljs-comment">; X8 = this-&gt;_machineState</span><br>    <span class="hljs-keyword">MOV</span> <span class="hljs-built_in">X19</span>, <span class="hljs-built_in">X0</span>                       <span class="hljs-comment">; X19 = this (InterpFrameGroup*)</span><br>    LDRSW <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x20</span>]              <span class="hljs-comment">; X9 = _frameTopIdx</span><br>    <span class="hljs-keyword">CMP</span> <span class="hljs-built_in">W9</span>, <span class="hljs-number">#1</span><br>    B.LT loc_F5D984                   <span class="hljs-comment">; 若 frameTopIdx &lt; 1，则没有 frame</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x18</span>]                <span class="hljs-comment">; X8 = _frameBase</span><br>    <span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X9</span>, <span class="hljs-keyword">LSL</span> <span class="hljs-number">#6</span>            <span class="hljs-comment">; X8 = _frameBase + frameTopIdx * sizeof(InterpFrame)</span><br>    <span class="hljs-keyword">SUB</span> <span class="hljs-built_in">X20</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-number">#0x40</span>                <span class="hljs-comment">; X20 = GetTopFrame() = base + idx - 1</span><br>    <span class="hljs-keyword">B</span> loc_F5D988<br><br><span class="hljs-symbol">loc_F5D984:</span><br>    <span class="hljs-keyword">MOV</span> <span class="hljs-built_in">X20</span>, XZR                      <span class="hljs-comment">; frame = nullptr</span><br><br><span class="hljs-symbol">loc_F5D988:</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X20</span>]                     <span class="hljs-comment">; X8 = frame-&gt;method</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X0</span>, [<span class="hljs-built_in">X8</span>]                      <span class="hljs-comment">; X0 = frame-&gt;method-&gt;method</span><br>    <span class="hljs-keyword">BL</span> sub_C4E428                     <span class="hljs-comment">; profiler_method_exit(method)</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X20</span>,<span class="hljs-number">#0x28</span>]               <span class="hljs-comment">; X8 = frame-&gt;exFlowBase</span><br>    <span class="hljs-keyword">CBZ</span> <span class="hljs-built_in">X8</span>, loc_F5D9BC                <span class="hljs-comment">; 若无异常流，跳过</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X9</span>, [<span class="hljs-built_in">X19</span>]                     <span class="hljs-comment">; X9 = _machineState</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X10</span>,[<span class="hljs-built_in">X9</span>,<span class="hljs-number">#0x28</span>]                <span class="hljs-comment">; X10 = _exceptionFlowBase</span><br>    <span class="hljs-keyword">SUB</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X10</span>                   <span class="hljs-comment">; X8 = exFlowBase - exceptionFlowBase (字节差)</span><br>    <span class="hljs-keyword">LSR</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-number">#3</span>                    <span class="hljs-comment">; /8</span><br>    <span class="hljs-keyword">MOV</span> <span class="hljs-built_in">W10</span>,<span class="hljs-number">#0xAAAB</span><br>    MOVK <span class="hljs-built_in">W10</span>,<span class="hljs-number">#0xAAAA</span>,LSL<span class="hljs-number">#16</span>           <span class="hljs-comment">; W10 = 0xAAAAAAAB</span><br>    <span class="hljs-keyword">MUL</span> <span class="hljs-built_in">W8</span>, <span class="hljs-built_in">W8</span>, <span class="hljs-built_in">W10</span>                   <span class="hljs-comment">; /3 → 等价于 /24</span><br>    <span class="hljs-keyword">STR</span> <span class="hljs-built_in">W8</span>, [<span class="hljs-built_in">X9</span>,<span class="hljs-number">#0x30</span>]                <span class="hljs-comment">; _exceptionFlowTopIdx = (top - base)</span><br><br><span class="hljs-symbol">loc_F5D9BC:</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X19</span>]                     <span class="hljs-comment">; X8 = _machineState</span><br>    <span class="hljs-keyword">MOV</span> <span class="hljs-built_in">X0</span>, XZR                       <span class="hljs-comment">; 默认返回 nullptr</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x20</span>]                <span class="hljs-comment">; W9 = _frameTopIdx</span><br>    <span class="hljs-keyword">SUB</span> <span class="hljs-built_in">W9</span>, <span class="hljs-built_in">W9</span>, <span class="hljs-number">#1</span><br>    <span class="hljs-keyword">STR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x20</span>]                <span class="hljs-comment">; PopFrame(): --_frameTopIdx</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X19</span>]<br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X20</span>,<span class="hljs-number">#0x10</span>]               <span class="hljs-comment">; frame-&gt;oldStackTop</span><br>    <span class="hljs-keyword">STR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x0C</span>]                <span class="hljs-comment">; _stackTopIdx = oldStackTop</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X19</span>]<br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X20</span>,<span class="hljs-number">#0x38</span>]               <span class="hljs-comment">; frame-&gt;oldLocalPoolBottomIdx</span><br>    <span class="hljs-keyword">STR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x10</span>]                <span class="hljs-comment">; _localPoolBottomIdx = oldLocalPoolBottomIdx</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X19</span>]<br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W9</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x20</span>]                <span class="hljs-comment">; W9 = _frameTopIdx</span><br>    <span class="hljs-keyword">CMP</span> <span class="hljs-built_in">W9</span>, <span class="hljs-number">#1</span><br>    B.LT loc_F5DA14                   <span class="hljs-comment">; 若无 frame，返回 nullptr</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">W10</span>,[<span class="hljs-built_in">X19</span>,<span class="hljs-number">#0x0C</span>]               <span class="hljs-comment">; W10 = _frameBaseIdx</span><br>    <span class="hljs-keyword">CMP</span> <span class="hljs-built_in">W9</span>, <span class="hljs-built_in">W10</span><br>    B.LS loc_F5DA14                   <span class="hljs-comment">; 若 &lt;= baseIdx，返回 nullptr</span><br>    <span class="hljs-keyword">LDR</span> <span class="hljs-built_in">X8</span>, [<span class="hljs-built_in">X8</span>,<span class="hljs-number">#0x18</span>]                <span class="hljs-comment">; X8 = _frameBase</span><br>    SXTW <span class="hljs-built_in">X9</span>, <span class="hljs-built_in">W9</span><br>    <span class="hljs-keyword">ADD</span> <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-built_in">X9</span>, <span class="hljs-keyword">LSL</span> <span class="hljs-number">#6</span><br>    <span class="hljs-keyword">SUB</span> <span class="hljs-built_in">X0</span>, <span class="hljs-built_in">X8</span>, <span class="hljs-number">#0x40</span>                 <span class="hljs-comment">; 返回新的 GetTopFrame()，即caller Frame</span><br><br><span class="hljs-symbol">loc_F5DA14:</span><br>    LDP <span class="hljs-built_in">X29</span>, <span class="hljs-built_in">X30</span>, [<span class="hljs-built_in">SP</span>,<span class="hljs-number">#0x10</span>]          <span class="hljs-comment">; 恢复 FP/LR</span><br>    LDP <span class="hljs-built_in">X20</span>, <span class="hljs-built_in">X19</span>, [<span class="hljs-built_in">SP</span>],<span class="hljs-number">#0x20</span>          <span class="hljs-comment">; 恢复寄存器并回收栈</span><br>    RET<br></code></pre></td></tr></table></figure><p>可见X25 在整个<code>LeaveFrame</code>执行期间保持不变，<code>LeaveFrame</code>最终返回<code>X0 = caller Frame</code>。现在可以确认：<strong>在<code>CMP X19, X8</code>语句处观测X25寄存器，即可获得当前method；读写X8寄存器指向的内存，即可读写函数返回值。</strong></p><h3 id="0x04-函数返回值读取"><a href="#0x04-函数返回值读取" class="headerlink" title="0x04 函数返回值读取"></a>0x04 函数返回值读取</h3><p>函数原型：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// Token: 0x170005D7 RID: 1495</span><br><span class="hljs-comment">// (get) Token: 0x06002918 RID: 10520 RVA: 0x000BA685 File Offset: 0x000B8885</span><br><span class="hljs-keyword">public</span> ObscuredFloat UpgradeReformSuccessRate &#123;<br><span class="hljs-keyword">get</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0.001f</span> * (<span class="hljs-built_in">float</span>)<span class="hljs-keyword">this</span>.Level;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里需先在Github上找一份成品<code>ObscuredFloat</code>结构体定义并自行引用：<a href="https://github.com/foxcookie/Goose_Goose_Duck_Hack/blob/906fe0899cae742a6cd666983d25af85ebc8a2e6/Struct/ObscuredTypes.hpp#L80">传送门</a></p><p>可知<code>ObscuredFloat</code>结构体在内存中的真实布局为24字节：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">slot0 (0x00~0x07): currentCryptoKey | hiddenValue<br>slot1 (0x08~0x0F): hiddenValueOldByte4 | inited + padding<br>slot2 (0x10~0x17): fakeValue | fakeValueActive + padding<br></code></pre></td></tr></table></figure><p>示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//0xF5D8E0 InterpFrame* EnterFrameFromInterpreter(const InterpMethodInfo* imi, StackObject* argBase)</span><br><span class="hljs-built_in">HOOK_DEF</span>(InterpFrame*, EnterFrameFromInterpreter, InterpFrame* self, <span class="hljs-type">const</span> InterpMethodInfo* imi, StackObject* argBase) &#123;<br>    InterpFrame* newFrame = <span class="hljs-built_in">orig_EnterFrameFromInterpreter</span>(self, imi, argBase);<br>    <span class="hljs-type">const</span> MethodInfo* method = imi-&gt;method;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = method-&gt;name;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;get_UpgradeReformSuccessRate&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;[Interp] get_UpgradeReformSuccessRate called frame=%p method=%p&quot;</span>, newFrame, method);<br>    &#125;<br>    <span class="hljs-keyword">return</span> newFrame;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">on_ret24_cmp</span><span class="hljs-params">(<span class="hljs-type">void</span> *address, DobbyRegisterContext *ctx)</span> </span>&#123;<br>    <span class="hljs-type">uint64_t</span> x8  = ctx-&gt;general.regs.x8;<br>    InterpFrame* frame = (InterpFrame*)ctx-&gt;general.regs.x25;<br>    <span class="hljs-type">const</span> MethodInfo* method = frame-&gt;method-&gt;method;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = frame-&gt;method-&gt;method-&gt;name;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;get_UpgradeReformSuccessRate&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;F4B260 hit:&quot;</span>);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  X8  (ret src)   = %p&quot;</span>, (<span class="hljs-type">void</span>*)x8);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;InterpFrame:&quot;</span>);<br>        <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;  self          = %p&quot;</span>, frame);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  imiMethod     = %p&quot;</span>, frame-&gt;method);<br>        <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;  method        = %p&quot;</span>, frame-&gt;method-&gt;method);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  stackBasePtr  = %p&quot;</span>, frame-&gt;stackBasePtr);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  oldStackTop   = %d&quot;</span>, frame-&gt;oldStackTop);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  ret           = %p&quot;</span>, frame-&gt;ret);<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  ip            = %p&quot;</span>, frame-&gt;ip);<br><br>        <span class="hljs-comment">// dump return slot memory</span><br>        <span class="hljs-type">uint8_t</span> dump[<span class="hljs-number">24</span>];<br>        <span class="hljs-built_in">memcpy</span>(dump, (<span class="hljs-type">void</span>*)x8, <span class="hljs-built_in">sizeof</span>(dump));<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">24</span>; i += <span class="hljs-number">8</span>) &#123;<br>            <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;  ret +%02X: %02X %02X %02X %02X %02X %02X %02X %02X&quot;</span>,<br>                 i,<br>                 dump[i<span class="hljs-number">+0</span>], dump[i<span class="hljs-number">+1</span>], dump[i<span class="hljs-number">+2</span>], dump[i<span class="hljs-number">+3</span>],<br>                 dump[i<span class="hljs-number">+4</span>], dump[i<span class="hljs-number">+5</span>], dump[i<span class="hljs-number">+6</span>], dump[i<span class="hljs-number">+7</span>]);<br>        &#125;<br>        <span class="hljs-keyword">auto</span>* of = (ObscuredFloat*)x8;<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;Original ObscuredFloat:&quot;</span>);<br>        <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;  key=%d hidden=0x%08X inited=%d fake=%f fakeActive=%d&quot;</span>,<br>             of-&gt;currentCryptoKey, (<span class="hljs-type">uint32_t</span>)of-&gt;hiddenValue, of-&gt;inited,<br>             of-&gt;fakeValue, of-&gt;fakeValueActive);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Use absolute address for test</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doHook</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">HOOK_FUNC</span>((il2cpp_base + <span class="hljs-number">0xF5D8E0</span>), EnterFrameFromInterpreter);  <span class="hljs-comment">// 双向观测</span><br>    <span class="hljs-built_in">DobbyInstrument</span>((<span class="hljs-type">void</span>*)(il2cpp_base + <span class="hljs-number">0xF4B260</span>), on_ret24_cmp);<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果：</p><p><img src="/img/hybridCLR/0x04-1.png"></p><h3 id="0x05-函数返回值修改"><a href="#0x05-函数返回值修改" class="headerlink" title="0x05 函数返回值修改"></a>0x05 函数返回值修改</h3><p>示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">on_ret24_cmp</span><span class="hljs-params">(<span class="hljs-type">void</span> *address, DobbyRegisterContext *ctx)</span> </span>&#123;<br>    <span class="hljs-type">uint64_t</span> x8  = ctx-&gt;general.regs.x8;<br>    InterpFrame* frame = (InterpFrame*)ctx-&gt;general.regs.x25;<br>    <span class="hljs-type">const</span> MethodInfo* method = frame-&gt;method-&gt;method;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name = frame-&gt;method-&gt;method-&gt;name;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;get_UpgradeReformSuccessRate&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;Original ObscuredFloat:&quot;</span>);<br>        <span class="hljs-built_in">LOGW</span>(<span class="hljs-string">&quot;  key=%d hidden=0x%08X inited=%d fake=%f fakeActive=%d&quot;</span>,<br>             of-&gt;currentCryptoKey, (<span class="hljs-type">uint32_t</span>)of-&gt;hiddenValue, of-&gt;inited,<br>             of-&gt;fakeValue, of-&gt;fakeValueActive);<br><br>        of-&gt;fakeValueActive = <span class="hljs-literal">true</span>;<br>        of-&gt;<span class="hljs-built_in">Encrypt</span>(<span class="hljs-number">0.25f</span>);<br>        of-&gt;inited = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;New ObscuredFloat:&quot;</span>);<br>        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">&quot;  key=%d hidden=0x%08X inited=%d fake=%f fakeActive=%d&quot;</span>,<br>             of-&gt;currentCryptoKey, (<span class="hljs-type">uint32_t</span>)of-&gt;hiddenValue, of-&gt;inited,<br>             of-&gt;fakeValue, of-&gt;fakeValueActive);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行结果：</p><p><img src="/img/hybridCLR/0x05-1.png"></p><h2 id="下一步待实现"><a href="#下一步待实现" class="headerlink" title="下一步待实现"></a>下一步待实现</h2><p><del>画大饼时间到</del></p><div>            <input type="checkbox"  >自动识别 EnterFrameFromNative、FromInterpreter 并hook          </div><div>            <input type="checkbox"  >自动识别所有 Ret case 并插桩          </div><div>            <input type="checkbox"  >高版本HybridCLR支持          </div><div>            <input type="checkbox"  >区分数据类型，提供更多示例          </div>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
      <tag>HybridCLR</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Coderustle2 (ver 1.8.16)</title>
    <link href="/coderustle2/"/>
    <url>/coderustle2/</url>
    
    <content type="html"><![CDATA[<p>各位，很久不见，我是长期摸鱼的Floeice😇。原有的BLOG（floe-ice.cn）因为尚在服役、服务器和域名双双过期等不可抗力因素，已经化为历史尘埃。转眼本人重新回归到了跟生活对线的状态，是时候也有时间开始做一些新的产出了。</p><span id="more"></span><p>目前手边正有一款Roguelike的单机手游，最大的乐趣兼痛点自不用说，就是装备的词条（Affix）打造。下文将以修改词条洗炼逻辑为主要目的，尝试从不同角度开展对应逆向工程。</p><div class="note note-info">            <p>APP: com.wingjoy.coderustle2 (ver 1.8.16)<br>OS: Redmi K40 with HyperOS 1.0.6.0 (Android 13)<br>Tools: frida 16.1.0 &#x2F; frida-tools 12.1.0 &#x2F; frida-il2cpp-bridge 0.9.1</p>          </div><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><h3 id="0x00-分析架构"><a href="#0x00-分析架构" class="headerlink" title="0x00 分析架构"></a>0x00 分析架构</h3><p>使用LibChecker分析该游戏架构，确认为Unity il2cpp。使用<a href="https://github.com/BryanGIG/PADumper">PADumper</a>从内存中获取libil2cpp.so及global-metadata.dat，而后使用<a href="https://github.com/Perfare/Il2CppDumper">Il2CppDumper</a>获取DummyDll及dump.cs以供后续分析。此处发现，libil2cpp.so中并不包含<code>Assembly-CSharp.dll</code>这个关键的游戏核心Assembly，但存在<code>HybridCLR.Runtime.dll</code>第三方C#热更新框架，其官方文档附后：<a href="https://www.hybridclr.cn/docs/intro">HybridCLR介绍</a>。</p><p>通过查看原始apk内容，发现该游戏base.apk\assets\Dll目录下存在25个dll.bytes、1个VersionInfo.json配置文件。查看可知其dll命名规则为“name+md5”，同时明确Assembly-CSharp以HotFix形式加载：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;isNormalUpdate&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;currentBuildVersionUpdateTips&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;版本(1.8.16)修复了一些bug，建议更新！&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;isInWhiteList&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;1.8.16&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;dllHashs&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;assembly-CSharp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Assembly-CSharp&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">4497424</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;md5&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;57955f3fa376dc99d8d1d6b238507d7b&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;isHot&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;persistent&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;sumSize&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>经测试，<code>Assembly-CSharp</code>、<code>CodeRustle.WingjoyFramework</code>、<code>WingjoyDebugger.Runtime</code>、<code>WingjoyUtilities.Runtime</code>、<code>WinjoyFramework.Runtime</code>共5个dll.bytes文件为加密状态，其他可被dnSpy正确识别为dll。由此，可基本确认游戏核心逻辑由HybridCLR以AOT或HotFix形式进行加载更新，上述5个加密dll.bytes文件于运行时解密。</p><h3 id="0x01-分析注入点"><a href="#0x01-分析注入点" class="headerlink" title="0x01 分析注入点"></a>0x01 分析注入点</h3><p>使用IDA载入libil2cpp.so，定位至<code>HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly(0x1EB35DC)</code>，查看其交叉引用并向上定位至<code>Wingjoy.Framework.Runtime.Launcher._LoadAotAndHotfixDlls_d__32.MoveNext(0x1DB35B8)</code>。可以发现该函数通过调用<code>Wingjoy.Framework.Runtime.WingjoyFramework.GetEncryptSetting(0x10B2058)</code>、<code>Wingjoy.Framework.Runtime.Launcher.BytesReaderInStreamingAssets(0x10A87CC)</code>、<code>System.Reflection.Assembly.Load_23524532(0x166F4B4)</code>及<code>HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly(0x1EB35DC)</code>等函数分别执行加密参数获取、dll.bytes文件读取并解密、Assembly加载等流程。</p><h4 id="1-dll-bytes解密流程"><a href="#1-dll-bytes解密流程" class="headerlink" title="1.dll.bytes解密流程"></a>1.dll.bytes解密流程</h4><p>进入<code>Wingjoy.Framework.Runtime.WingjoyFramework.GetEncryptSetting</code>：</p><p><img src="/img/coderustle2/0x01-1.png"></p><p>可知这段函数构造一个RijndaelManaged对象（AES），读取并设置RijndaelManaged的Key&#x2F;IV&#x2F;Mode &#x3D; CBC&#x2F;Padding &#x3D; PKCS7&#x2F;BlockSize &#x3D; 128，最终返回配置好的RijndaelManaged实例，伪代码如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function">RijndaelManaged <span class="hljs-title">GetEncryptSetting</span>()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!inited) &#123;<br>        sub_C4E34C(globalObj1);<br>        sub_C4E34C(<span class="hljs-string">&quot;€3*@&#123;&quot;</span>);<br>        sub_C4E34C(<span class="hljs-string">&quot;€2*@&#123;&quot;</span>);<br>        inited = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">var</span> rij = <span class="hljs-keyword">new</span> RijndaelManaged();<br>    <span class="hljs-built_in">byte</span>[] key = Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;€2*@&#123;&quot;</span>);<br>    rij.Key = key;<br>    <span class="hljs-built_in">byte</span>[] iv = Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;€3*@&#123;&quot;</span>);<br>    rij.IV = iv;<br>    rij.Mode = CipherMode.CBC;<br>    rij.Padding = PaddingMode.PKCS7;<br>    rij.BlockSize = <span class="hljs-number">128</span>;<br>    <span class="hljs-keyword">return</span> rij;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中全局字符串<code>€3*@&#123;</code>、<code>€2*@&#123;</code>实际为Key和IV的占位符，需动态获取，可通过hook <code>System.Security.Cryptography.RijndaelManaged.CreateDecryptor(0x12662C0)</code>的<code>Args[1]</code>、<code>Args[2]</code>来获得。其函数原型为：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> ICryptoTransform <span class="hljs-title">CreateDecryptor</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-built_in">byte</span>[] rgbKey,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-built_in">byte</span>[] rgbIV</span></span><br><span class="hljs-params"><span class="hljs-function"></span>)</span>;<br></code></pre></td></tr></table></figure><h4 id="2-Assembly加载流程"><a href="#2-Assembly加载流程" class="headerlink" title="2.Assembly加载流程"></a>2.Assembly加载流程</h4><p>在正式分析之前，先学习一下他人的正向开发教程：<a href="https://zhuanlan.zhihu.com/p/649757859">HybridCLR热更+简单实战</a>，重点查看加载AOT元数据DLL任务及加载热更DLL任务部分代码：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> UniTask _load_hotfix_dlls() &#123;<br>    <span class="hljs-comment">// 加载热更DLL</span><br>    <span class="hljs-comment">// 这里使用标签来加载资源 Addressables会自动根据标签来加载所有资源</span><br>    <span class="hljs-keyword">var</span> dlls = <span class="hljs-keyword">await</span> Addressables.LoadAssetsAsync&lt;TextAsset&gt;(hotUpdateDllLabelRef, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> asset <span class="hljs-keyword">in</span> dlls) &#123;<br>        Debug.Log(<span class="hljs-string">&quot;加载热更DLL:&quot;</span> + asset.name);<br>        Assembly.Load(asset.bytes);<br>        Debug.Log(<span class="hljs-string">&quot;加载热更DLL:&quot;</span> + asset.name + <span class="hljs-string">&quot;完成&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> UniTask _load_meta_data_for_aot_dlls() &#123;<br>    <span class="hljs-comment">//这一步实际上是为了解决AOT 泛型类的问题 </span><br>    HomologousImageMode mode = HomologousImageMode.SuperSet;<br>    <span class="hljs-keyword">var</span> aots = <span class="hljs-keyword">await</span> Addressables.LoadAssetsAsync&lt;TextAsset&gt;(aotMetadataDllLabelRef, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> asset <span class="hljs-keyword">in</span> aots) &#123;<br>        LoadImageErrorCode errorCode = RuntimeApi.LoadMetadataForAOTAssembly(asset.bytes, mode);<br>        <span class="hljs-keyword">if</span> (errorCode == LoadImageErrorCode.OK) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        Debug.LogError(<span class="hljs-string">$&quot;加载AOT元数据DLL:<span class="hljs-subst">&#123;asset.name&#125;</span>失败,错误码:<span class="hljs-subst">&#123;errorCode&#125;</span>&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可知HotFix形式的dll通过<code>Assembly.Load</code>加载，AOT元数据dll通过<code>RuntimeApi.LoadMetadataForAOTAssembly</code>加载。</p><p>现在我们回到IDA，<code>System.Reflection.Assembly.Load_23524532(0x166F4B4)</code>的函数原型为：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Assembly <span class="hljs-title">Load</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] rawAssembly</span>)</span>;<br></code></pre></td></tr></table></figure><p><code>HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly(0x1EB35DC)</code>的函数原型为：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">LoadMetadataForAOTAssembly</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>* dllBytes, <span class="hljs-built_in">int</span> dllSize, <span class="hljs-built_in">int</span> mode</span>)</span>;<br></code></pre></td></tr></table></figure><p>rawAssembly、dllBytes对应的byte[]指针&#x2F;数组在il2cpp中均遵循Il2CppArray布局：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">struct</span> Il2CppArray &#123;<br>    Il2CppObject obj;     <span class="hljs-comment">// 0x00: 对象头（klass 指针 + monitor）</span><br>    Il2CppArrayBounds* bounds; <span class="hljs-comment">// 0x10: 可选，多维数组才有；一维数组为 NULL</span><br>    uint32_t max_length;  <span class="hljs-comment">// 0x18: 数组长度</span><br>    T m_Items[<span class="hljs-number">0</span>];         <span class="hljs-comment">// 0x20: 数据起始位置</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>其内存结构为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">+0x00  Il2CppClass* klass<br>+0x08  MonitorData* monitor<br>+0x10  NULL (一维数组)<br>+0x18  uint32_t length<br>+0x1C  padding<br>+0x20  uint8_t data[length]<br></code></pre></td></tr></table></figure><p>因此通过hook <code>Args[0]+0x18</code>即可获得Assembly长度，而后hook <code>Args[0]+0x20</code>即可获得全部数据。</p><h3 id="0x02-解密Assembly-CSharp-dll-bytes的2种方式"><a href="#0x02-解密Assembly-CSharp-dll-bytes的2种方式" class="headerlink" title="0x02 解密Assembly-CSharp.dll.bytes的2种方式"></a>0x02 解密Assembly-CSharp.dll.bytes的2种方式</h3><p>没啥好说的，这游戏没壳（曾经有用过FairGuard，但大概后续没再续费😥），直接frida一把梭。</p><p>手机端在root权限下运行server：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">alioth:/data/local/tmp <span class="hljs-comment"># ./frida-server-16.1.0-android-arm64</span><br></code></pre></td></tr></table></figure><p>电脑端通过以下命令直接注入脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">frida -Uf com.wingjoy.coderustle2 -l D:\Floeice\com.wingjoy.coderustle2\Hook\frida.js<br></code></pre></td></tr></table></figure><h4 id="1-通过动态获取AES-Key-IV执行通用解密"><a href="#1-通过动态获取AES-Key-IV执行通用解密" class="headerlink" title="1.通过动态获取AES Key&#x2F;IV执行通用解密"></a>1.通过动态获取AES Key&#x2F;IV执行通用解密</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">readIl2cppByteArray</span>(<span class="hljs-params">arr</span>) &#123;<br>    <span class="hljs-keyword">if</span> (arr.<span class="hljs-title function_">isNull</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">const</span> length = arr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x18</span>).<span class="hljs-title function_">readU32</span>();<br>    <span class="hljs-keyword">const</span> data = arr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">readByteArray</span>(length);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">tryHook</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;libil2cpp.so&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!base) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-comment">//CreateDecryptor绝对偏移</span><br>    <span class="hljs-keyword">const</span> offset = <span class="hljs-number">0x12662C0</span>;<br>    <span class="hljs-keyword">const</span> target = base.<span class="hljs-title function_">add</span>(offset);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hook CreateDecryptor @&quot;</span>, target);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target, &#123;<br>        <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">readIl2cppByteArray</span>(args[<span class="hljs-number">1</span>]);<br>                <span class="hljs-keyword">const</span> iv  = <span class="hljs-title function_">readIl2cppByteArray</span>(args[<span class="hljs-number">2</span>]);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\n[CreateDecryptor] Key:&quot;</span>);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(key, &#123; <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span> &#125;));<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\n[CreateDecryptor] IV:&quot;</span>);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(iv, &#123; <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span> &#125;));<br>            &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] 读取失败:&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">tryHook</span>()) <span class="hljs-built_in">clearInterval</span>(timer);<br>&#125;, <span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure><p>执行结果：</p><p><img src="/img/coderustle2/0x02-1.png"></p><p>可知Key &#x3D; <strong>WingjoyGame_2023</strong>，IV &#x3D; <strong>WingjoyGame_2017</strong>。分别新建EncryptedDll、DecryptedDll文件夹，将所有dll.bytes文件放入EncryptedDll中，接着写一个批量解密python脚本即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> unpad<br><br>ENCRYPTED_DIR = Path(<span class="hljs-string">r&quot;D:\Floeice\com.wingjoy.coderustle2\EncryptedDll&quot;</span>)   <span class="hljs-comment"># 加密文件目录</span><br>DECRYPTED_DIR = Path(<span class="hljs-string">r&quot;D:\Floeice\com.wingjoy.coderustle2\DecryptedDll&quot;</span>)   <span class="hljs-comment"># 解密输出目录</span><br><br>KEY = <span class="hljs-string">b&quot;WingjoyGame_2023&quot;</span>   <span class="hljs-comment"># 16 bytes → AES-128</span><br>IV  = <span class="hljs-string">b&quot;WingjoyGame_2017&quot;</span>   <span class="hljs-comment"># 16 bytes</span><br><span class="hljs-comment"># ==========================</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">try_decrypt</span>(<span class="hljs-params">ciphertext: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span> | <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;尝试解密，如果失败（说明不是加密文件）则返回 None&quot;&quot;&quot;</span><br>    cipher = AES.new(KEY, AES.MODE_CBC, IV)<br>    plaintext = cipher.decrypt(ciphertext)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> unpad(plaintext, AES.block_size)<br>    <span class="hljs-keyword">except</span> ValueError:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># padding 错误 → 未加密</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_file</span>(<span class="hljs-params">in_path: Path, out_path: Path</span>):<br>    <span class="hljs-keyword">with</span> in_path.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        ciphertext = f.read()<br>    result = try_decrypt(ciphertext)<br>    <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[skip] Not encrypted: <span class="hljs-subst">&#123;in_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-comment"># 修改输出扩展名为 .dll</span><br>    out_path = out_path.with_suffix(<span class="hljs-string">&quot;.dll&quot;</span>)<br>    out_path.parent.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">with</span> out_path.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(result)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[ok] Decrypted: <span class="hljs-subst">&#123;in_path&#125;</span> -&gt; <span class="hljs-subst">&#123;out_path&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_dir</span>(<span class="hljs-params">input_dir: Path, output_dir: Path</span>):<br>    <span class="hljs-keyword">for</span> root, _, files <span class="hljs-keyword">in</span> os.walk(input_dir):<br>        root_path = Path(root)<br>        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> files:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> name.endswith(<span class="hljs-string">&quot;.bytes&quot;</span>):<br>                <span class="hljs-keyword">continue</span>  <span class="hljs-comment"># 只处理 .bytes</span><br>            in_path = root_path / name<br>            rel_path = in_path.relative_to(input_dir)<br>            out_path = output_dir / rel_path<br>            decrypt_file(in_path, out_path)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[*] Input : <span class="hljs-subst">&#123;ENCRYPTED_DIR&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[*] Output: <span class="hljs-subst">&#123;DECRYPTED_DIR&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ENCRYPTED_DIR.is_dir():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[!] Input directory not found: <span class="hljs-subst">&#123;ENCRYPTED_DIR&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    decrypt_dir(ENCRYPTED_DIR, DECRYPTED_DIR)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Done.&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p>执行后得到包含Assembly-CSharp在内的5个解密dll：</p><p><img src="/img/coderustle2/0x02-2.png"></p><h4 id="2-通过hook-Assembly-Load直接获取解密内容"><a href="#2-通过hook-Assembly-Load直接获取解密内容" class="headerlink" title="2.通过hook Assembly.Load直接获取解密内容"></a>2.通过hook Assembly.Load直接获取解密内容</h4><p>更直接，更强硬🥵，直接将解密后的<code>Assembly-CSharp.dll</code> dump至&#x2F;sdcard&#x2F;Download目录下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;frida-il2cpp-bridge&quot;</span>;<br><br><span class="hljs-keyword">const</span> RVA_AsmLoadBytes = <span class="hljs-number">0x166F4B4</span>;<br><br><span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">module</span>.<span class="hljs-property">base</span>;<br>    <span class="hljs-keyword">const</span> target = base.<span class="hljs-title function_">add</span>(RVA_AsmLoadBytes);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking Assembly.Load(byte[]) @&quot;</span>, target);<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target, &#123;<br>        <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-keyword">const</span> rawAssembly = args[<span class="hljs-number">0</span>];<br>            <span class="hljs-comment">// IL2CPP byte[] layout</span><br>            <span class="hljs-keyword">const</span> length  = rawAssembly.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x18</span>).<span class="hljs-title function_">readU32</span>();<br>            <span class="hljs-keyword">const</span> dataPtr = rawAssembly.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x20</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\n[Assembly.Load] length =&quot;</span>, length);<br>            <span class="hljs-comment">// 只 dump Assembly-CSharp.dll</span><br>            <span class="hljs-keyword">if</span> (length === <span class="hljs-number">4497408</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Detected Assembly-CSharp.dll, dumping...&quot;</span>);<br>                <span class="hljs-keyword">const</span> raw = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readByteArray</span>(dataPtr, length);<br>                <span class="hljs-keyword">const</span> path = <span class="hljs-string">&quot;/sdcard/Download/Assembly-CSharp.dll&quot;</span>;<br>                <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path, <span class="hljs-string">&quot;wb&quot;</span>);<br>                file.<span class="hljs-title function_">write</span>(raw);<br>                file.<span class="hljs-title function_">flush</span>();<br>                file.<span class="hljs-title function_">close</span>();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Saved Assembly-CSharp.dll to&quot;</span>, path);<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>同理，此处亦可作为后续<code>Assembly-CSharp.dll</code>替换的关键载点。</strong></p><div class="note note-warning">            <p>额外说明：仅Assembly-CSharp.dll通过Assembly.Load加载，其余24个AOT Assembly均通过RuntimeApi.LoadMetadataForAOTAssembly加载。此处加载逻辑可通过下述脚本自行验证。</p>          </div>    <div class="fold">      <div class="fold-title fold-success collapsed" data-toggle="collapse" href="#collapse-b83a4609" role="button" aria-expanded="false" aria-controls="collapse-b83a4609">        <div class="fold-arrow">▶</div>验证脚本      </div>      <div class="fold-collapse collapse" id="collapse-b83a4609">        <div class="fold-content">          <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;frida-il2cpp-bridge&quot;</span>;<br><br><span class="hljs-keyword">const</span> RVA_LoadMeta      = <span class="hljs-number">0x1EB35DC</span>;  <span class="hljs-comment">// HybridCLR_RuntimeApi__LoadMetadataForAOTAssembly</span><br><span class="hljs-keyword">const</span> RVA_AsmLoadBytes  = <span class="hljs-number">0x166F4B4</span>;  <span class="hljs-comment">// System_Reflection_Assembly__Load_23524532</span><br><br><span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">module</span>.<span class="hljs-property">base</span>;<br>    <span class="hljs-comment">// ========== 1. Hook LoadMetadataForAOTAssembly ==========</span><br>    &#123;<br>        <span class="hljs-keyword">const</span> target = base.<span class="hljs-title function_">add</span>(RVA_LoadMeta);<br>        <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking LoadMetadataForAOTAssembly @&quot;</span>, target);<br><br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target, &#123;<br>            <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>                count++;<br>                <span class="hljs-keyword">const</span> dllBytes = args[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">const</span> mode     = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>();<br>                <span class="hljs-keyword">let</span> length = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// IL2CPP byte[]: +0x18 = max_length, +0x20 = data</span><br>                    length = dllBytes.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x18</span>).<span class="hljs-title function_">readU32</span>();<br>                &#125; <span class="hljs-keyword">catch</span> (e) &#123;&#125;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n===== LoadMetadataForAOTAssembly #<span class="hljs-subst">$&#123;count&#125;</span> =====`</span>);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;dllBytes =&quot;</span>, dllBytes);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;mode     =&quot;</span>, mode);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;length   =&quot;</span>, length);<br>            &#125;,<br><br>            <span class="hljs-title function_">onLeave</span>(<span class="hljs-params">retval</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;RET =&quot;</span>, retval.<span class="hljs-title function_">toInt32</span>());<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// ========== 2. Hook System.Reflection.Assembly.Load(byte[]) ==========</span><br>    &#123;<br>        <span class="hljs-keyword">const</span> target = base.<span class="hljs-title function_">add</span>(RVA_AsmLoadBytes);<br>        <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking System.Reflection.Assembly::Load(byte[]) @&quot;</span>, target);<br><br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target, &#123;<br>            <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>                count++;<br>                <span class="hljs-keyword">const</span> rawAssembly = args[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">let</span> length  = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">let</span> dataPtr = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 同样是 IL2CPP byte[] 布局</span><br>                    length  = rawAssembly.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x18</span>).<span class="hljs-title function_">readU32</span>();<br>                    dataPtr = rawAssembly.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x20</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (e) &#123;&#125;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n===== Assembly.Load(byte[]) #<span class="hljs-subst">$&#123;count&#125;</span> =====`</span>);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;rawAssembly =&quot;</span>, rawAssembly);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;length      =&quot;</span>, length);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;dataPtr     =&quot;</span>, dataPtr);<br>            &#125;,<br><br>            <span class="hljs-title function_">onLeave</span>(<span class="hljs-params">retval</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;RET =&quot;</span>, retval);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>        </div>      </div>    </div><h3 id="0x03-确认修改逻辑"><a href="#0x03-确认修改逻辑" class="headerlink" title="0x03 确认修改逻辑"></a>0x03 确认修改逻辑</h3><p>使用dnSpy打开解密后的<code>Assembly-CSharp.dll</code>，定位到:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">//Wingjoy.CodeRustle.HotFix.UI.ProcessingTableUIFormNS.RefinePanelUIGroup</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> AffixBase <span class="hljs-title">GetNewAffix</span>(<span class="hljs-params">EquipmentBase equipment, AffixBase oldAffix</span>)</span><br></code></pre></td></tr></table></figure><p>查看红框标注的装备词条洗炼关键逻辑：</p><p><img src="/img/coderustle2/0x03-1.png"></p><p>其中<code>CreateAffixParam</code>为构造函数：</p><p><img src="/img/coderustle2/0x03-2.png"></p><p>每洗炼一次，即赋予一次随机词条属性，同时将Refined &#x3D; true、Best &#x3D; value（结合上文，value实际 &#x3D; false）传入<code>CreateAffixParam</code>。结合游戏实际表现，可知正常逻辑下，洗炼得到的词条一定不为满值（非Best），且除被洗炼词条之外的其他词条均被锁定（被洗炼词条被标记为Refined）。为了实现每条词条均可洗炼，或洗炼必为满值（过于非法且暴力，不推荐🙃），可修改如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">bool value = <span class="hljs-literal">true</span>; //等效于Best = <span class="hljs-literal">true</span>，洗炼必为满值<br>Refined = <span class="hljs-literal">false</span>;   //被洗炼词条之外的其他词条不被锁定<br></code></pre></td></tr></table></figure><h2 id="修改实现"><a href="#修改实现" class="headerlink" title="修改实现"></a>修改实现</h2><h3 id="0x04-修改特定IL指令✔️"><a href="#0x04-修改特定IL指令✔️" class="headerlink" title="0x04 修改特定IL指令✔️"></a>0x04 修改特定IL指令✔️</h3><p>使用dnSpy的“编辑IL指令”功能，分别修改如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">//bool value = <span class="hljs-literal">true</span>;<br>0000 ldc.i4.0 --&gt; ldc.i4.1<br>//Refined = <span class="hljs-literal">false</span>;<br>0037 ldc.i4.1 --&gt; ldc.i4.0<br>0233 ldc.i4.1 --&gt; ldc.i4.0<br></code></pre></td></tr></table></figure><h3 id="0x05-替换并加载Assembly-CSharp-dll✔️"><a href="#0x05-替换并加载Assembly-CSharp-dll✔️" class="headerlink" title="0x05 替换并加载Assembly-CSharp.dll✔️"></a>0x05 替换并加载Assembly-CSharp.dll✔️</h3><p>将上述修改后的<code>Assembly-CSharp.dll</code>保存并push至手机端&#x2F;data&#x2F;local&#x2F;tmp目录下，确认文件权限无误的情况下，执行以下脚本：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;frida-il2cpp-bridge&quot;</span>;<br><br><span class="hljs-keyword">const</span> RVA_AsmLoadBytes = <span class="hljs-number">0x166F4B4</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REPLACE_PATH</span> = <span class="hljs-string">&quot;/data/local/tmp/Assembly-CSharp.dll&quot;</span>;<br><br><span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">module</span>.<span class="hljs-property">base</span>;<br>    <span class="hljs-keyword">const</span> target = base.<span class="hljs-title function_">add</span>(RVA_AsmLoadBytes);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking Assembly.Load(byte[]) @&quot;</span>, target);<br>    <span class="hljs-comment">// 先获取 System.Byte 的 Il2CppClass</span><br>    <span class="hljs-keyword">const</span> byteClass = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">corlib</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;System.Byte&quot;</span>);<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target, &#123;<br>        <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-keyword">const</span> orig = args[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">const</span> origLength = orig.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x18</span>).<span class="hljs-title function_">readU32</span>();<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] [Assembly.Load] original length =&quot;</span>, origLength);<br>            <span class="hljs-comment">// 读取替换 DLL</span><br>            <span class="hljs-keyword">let</span> file;<br>            <span class="hljs-keyword">try</span> &#123;<br>                file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-variable constant_">REPLACE_PATH</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] No replacement DLL found at&quot;</span>, <span class="hljs-variable constant_">REPLACE_PATH</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">const</span> newBytes = file.<span class="hljs-title function_">readBytes</span>();<br>            file.<span class="hljs-title function_">close</span>();<br>            <span class="hljs-keyword">if</span> (!newBytes || newBytes.<span class="hljs-property">byteLength</span> === <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] Replacement DLL is empty&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">const</span> newLength = newBytes.<span class="hljs-property">byteLength</span>;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Replacement DLL loaded, size =&quot;</span>, newLength);<br>            <span class="hljs-keyword">const</span> arr = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title function_">array</span>(byteClass, newLength);<br>            <span class="hljs-comment">// 写入数据</span><br>            <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">writeByteArray</span>(arr.<span class="hljs-property">handle</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x20</span>), newBytes);<br>            <span class="hljs-comment">// 替换参数</span><br>            args[<span class="hljs-number">0</span>] = arr.<span class="hljs-property">handle</span>;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Assembly.Load(byte[]) replaced with new DLL&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>执行结果：</p><p><img src="/img/coderustle2/0x03-3.png"></p><p>相对优雅的Native hook示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Assembly-CSharp.h&quot;</span></span><br><span class="hljs-function">Il2CppArray* <span class="hljs-title">createByteArrayFromHex</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">const</span> Il2CppImage* corlib = <span class="hljs-built_in">il2cpp_get_corlib</span>();<br>    Il2CppClass* byteClass = <span class="hljs-built_in">il2cpp_class_from_name</span>(corlib, <span class="hljs-string">&quot;System&quot;</span>, <span class="hljs-string">&quot;Byte&quot;</span>);<br>    Il2CppArray* arr = <span class="hljs-built_in">il2cpp_array_new</span>(byteClass, <span class="hljs-built_in">sizeof</span>(hexData));<br>    <span class="hljs-built_in">memcpy</span>(arr-&gt;vector, hexData, <span class="hljs-built_in">sizeof</span>(hexData));<br>    <span class="hljs-keyword">return</span> arr;<br>&#125;<br><br><span class="hljs-comment">// NameSpace: System.Reflection</span><br><span class="hljs-comment">// class: Assembly</span><br><span class="hljs-comment">// public static Assembly Load(byte[] rawAssembly);</span><br><span class="hljs-built_in">HOOK_DEF</span>(<span class="hljs-type">void</span>*, Load, Il2CppArray* rawAssembly) &#123;<br>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;[+] Original dll length: %lu&quot;</span>, rawAssembly-&gt;max_length);<br>    Il2CppArray* newAssembly = <span class="hljs-built_in">createByteArrayFromHex</span>();<br>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;[✓] Replaced with embedded dll, length: %lu&quot;</span>, newAssembly-&gt;max_length);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">orig_Load</span>(newAssembly);<br>&#125;<br><br><span class="hljs-comment">// Use absolute address for test</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">doHook</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">HOOK_FUNC</span>((il2cpp_base + <span class="hljs-number">0x166F4B4</span>), Load);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x06-尝试使用HybridCLR-Hook😕"><a href="#0x06-尝试使用HybridCLR-Hook😕" class="headerlink" title="0x06 尝试使用HybridCLR-Hook😕"></a>0x06 尝试使用HybridCLR-Hook😕</h3><p>替换加载dll的方法固然传统有效，可这并不是一个可复用程度高的方案，显得太“重”。经过搜索，偶然发现了一个2年前的Github项目，且现已商业化：<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook">IIIImmmyyy&#x2F;HybridCLR-Hook: Unity HybridCLRHook in runtime</a>，其开源版本支持对使用了HybirdCLR的热更游戏进行Hook（仅支持入参的替换）。出于好奇，我尝试clone该项目并在使用中尝试修复部分bug。因为实在是<del>过于曲折</del>🙃，以下仅记录关键过程。</p><p>1.<code>agent/SymbolFinder.js</code>中的<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook/blob/master/agent/SymbolFinder.js#L26">findEnterFrameFromInterpreter</a>、<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook/blob/master/agent/SymbolFinder.js#L41">findNative</a>均以特征码+指令解析方式尝试获取HybridCLR <a href="https://github.com/focus-creative-games/hybridclr/blob/main/hybridclr/interpreter/Engine.cpp#L29">InterpFrame* InterpFrameGroup::EnterFrameFromInterpreter</a>及<a href="https://github.com/focus-creative-games/hybridclr/blob/main/hybridclr/interpreter/Engine.cpp#L44">InterpFrame* InterpFrameGroup::EnterFrameFromNative</a>的真实入口。</p><p>2.<code>agent/HybirdCLR.js</code>主要实现了：解析方法结构体信息（根据<code>EnterFrameFromInterpreter</code>或<code>EnterFrameFromNative</code>传入的<code>MethodInfo* method</code>以及<code>StackObject* argBase</code>）、构造方法key、构造runtimeArgs并按pointerSize取出每个参数、执行用户回调以读取&#x2F;修改参数、注册用户观察点供Hook时按key匹配。</p><p>3.<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook/blob/master/agent/SymbolFinder.js#L28">SymbolFinder.js#L28</a>有误，其pattern扫描内容应根据HybridCLR实际版本修改为<code>&quot;E0 C3 21 91 E1 03 1B AA E2 03 19 AA&quot;</code>。</p><p>4.<a href="https://github.com/IIIImmmyyy/HybridCLR-Hook/blob/master/agent/SymbolFinder.js#L32">SymbolFinder.js#L32</a>有误，其指向的BL指令偏移地址应对应修改为<code>0xC</code>。</p><div class="note note-warning">            <p>在具备条件且时间充裕的情况下，强烈建议搭配正向开发（Unity 2020.3.x + HybirdCLR ）而后在不抹除符号表的情况下进行逆向食用更佳，如：<a href="https://github.com/focus-creative-games/hybridclr_trial">hybridclr_trial</a>。</p>          </div><p>完成上述修复后，我尝试hook了一个较为简单的战斗金币掉落函数以测试效果：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Wingjoy.CodeRustle.HotFix.UI.BattleUIForm</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddDropGoldCoins</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> <span class="hljs-title class_">TestJs</span>=&#123;<br>    <span class="hljs-attr">test</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-title class_">HybridCLR</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-string">&quot;Assembly-CSharp.dll&quot;</span>,<span class="hljs-string">&quot;Wingjoy.CodeRustle.HotFix.UI&quot;</span>,<span class="hljs-string">&quot;BattleUIForm&quot;</span>,<span class="hljs-string">&quot;AddDropGoldCoins&quot;</span>,<span class="hljs-number">1</span>,<br>            <span class="hljs-keyword">function</span> (<span class="hljs-params">methodInfo,runtimeArgs</span>)&#123;<br>                <span class="hljs-comment">//console.log(&quot;args len &quot;+runtimeArgs.length);</span><br>                <span class="hljs-keyword">let</span> count = runtimeArgs[<span class="hljs-number">1</span>].<span class="hljs-title function_">readU32</span>();<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;count: &quot;</span>+count);<br>                runtimeArgs[<span class="hljs-number">1</span>].<span class="hljs-title function_">writeU32</span>(count * <span class="hljs-number">50</span>); <span class="hljs-comment">//修改为50倍</span><br>            &#125;);<br>        <span class="hljs-title class_">HybridCLR</span>.<span class="hljs-title function_">attach</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>正常掉落：</p><p><img src="/img/coderustle2/0x06-1.png"></p><p>脚本执行LOG：</p><p><img src="/img/coderustle2/0x06-2.png"></p><p>Hook后掉落：</p><p><img src="/img/coderustle2/0x06-3.png"></p><p>可见<code>HybridCLR-Hook</code>对于简单的入参是有效的，其是否适用于其他复杂情况（如：入参为<code>ObscuredValue</code>；是否可以在<code>OnLeave</code>阶段处理函数RET）待后续再作测试。</p><h2 id="备忘"><a href="#备忘" class="headerlink" title="备忘"></a>备忘</h2><h3 id="0x07-部分物品特征码Hex"><a href="#0x07-部分物品特征码Hex" class="headerlink" title="0x07 部分物品特征码Hex"></a>0x07 部分物品特征码Hex</h3><p>此处直接使用<a href="https://gameguardian.net/forum/files/file/2-gameguardian/">GameGuardian</a>进行搜索，其中物品数量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">// 待修正，部分逻辑有误<br>RealValue = SearchBase - 0x8<br>ObscuredValue = SearchBase - 0x10 = RealValue ^ cryptoKey<br>cryptoKey = SearchBase - 0x14 = 444444<br></code></pre></td></tr></table></figure><p>RealValue与ObscuredValue需要同步修改，否则闪退。</p><p>特征码Hex见<a href="https://docs.google.com/spreadsheets/d/1fF_gSCNwWDQZT_PSzExrJRcsAXuECNiSXAXN8l4K3_Q/edit?gid=0#gid=0">Google表格</a>。</p><h3 id="0x08-强制开启Debug组件"><a href="#0x08-强制开启Debug组件" class="headerlink" title="0x08 强制开启Debug组件"></a>0x08 强制开启Debug组件</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// WingjoyDebugger.Runtime.DebuggerComponent</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br></code></pre></td></tr></table></figure>    <div class="fold">      <div class="fold-title fold-success collapsed" data-toggle="collapse" href="#collapse-639614a5" role="button" aria-expanded="false" aria-controls="collapse-639614a5">        <div class="fold-arrow">▶</div>Frida脚本，包含强制开启DebuggerComponent及查看调用栈      </div>      <div class="fold-collapse collapse" id="collapse-639614a5">        <div class="fold-content">          <figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;frida-il2cpp-bridge&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SET_ACTIVE_NATIVE_OFFSET</span> = <span class="hljs-number">0x1D96C9C</span>; <span class="hljs-comment">// native set_ActiveWindow</span><br><br><span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> unityAsm =<br>    <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">domain</span>.<span class="hljs-title function_">tryAssembly</span>(<span class="hljs-string">&quot;UnityEngine.CoreModule&quot;</span>) ??<br>    <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">domain</span>.<span class="hljs-title function_">tryAssembly</span>(<span class="hljs-string">&quot;UnityEngine&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!unityAsm) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[-] UnityEngine assembly not found&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> dbgAsm = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">domain</span>.<span class="hljs-title function_">tryAssembly</span>(<span class="hljs-string">&quot;WingjoyDebugger.Runtime&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!dbgAsm) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[-] WingjoyDebugger.Runtime not loaded&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">DebuggerComponent</span> = dbgAsm.<span class="hljs-property">image</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;WingjoyDebugger.Runtime.DebuggerComponent&quot;</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">Behaviour</span> = unityAsm.<span class="hljs-property">image</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;UnityEngine.Behaviour&quot;</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">GameObject</span> = unityAsm.<span class="hljs-property">image</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;UnityEngine.GameObject&quot;</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UObject</span> = unityAsm.<span class="hljs-property">image</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;UnityEngine.Object&quot;</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = unityAsm.<span class="hljs-property">image</span>.<span class="hljs-title function_">class</span>(<span class="hljs-string">&quot;UnityEngine.Component&quot;</span>);<br><br>  <span class="hljs-keyword">const</span> setEnabled = <span class="hljs-title class_">Behaviour</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;set_enabled&quot;</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> setActive = <span class="hljs-title class_">GameObject</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;SetActive&quot;</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> destroy = <span class="hljs-title class_">UObject</span>.<span class="hljs-title function_">tryMethod</span>(<span class="hljs-string">&quot;Destroy&quot;</span>, <span class="hljs-number">1</span>) ?? <span class="hljs-title class_">UObject</span>.<span class="hljs-title function_">tryMethod</span>(<span class="hljs-string">&quot;Destroy&quot;</span>, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">const</span> getName = <span class="hljs-title class_">UObject</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;get_name&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> getGameObject = <span class="hljs-title class_">Component</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;get_gameObject&quot;</span>, <span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">let</span> dbgComponentHandle = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">let</span> dbgGameObjectHandle = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">const</span> nativeSetActive = <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-property">module</span>.<span class="hljs-property">base</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable constant_">SET_ACTIVE_NATIVE_OFFSET</span>);<br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(nativeSetActive, &#123;<br>    <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-keyword">if</span> (args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>() === <span class="hljs-number">0</span>) &#123;<br>        args[<span class="hljs-number">1</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] set_ActiveWindow forced -&gt; true&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-comment">// 在 Start() 里捕获 this -&gt; gameObject</span><br>  <span class="hljs-keyword">const</span> dbgStart = <span class="hljs-title class_">DebuggerComponent</span>.<span class="hljs-title function_">tryMethod</span>(<span class="hljs-string">&quot;Start&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (!dbgStart) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[-] DebuggerComponent.Start not found&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking DebuggerComponent.Start @&quot;</span>, dbgStart.<span class="hljs-property">virtualAddress</span>);<br>  <br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(dbgStart.<span class="hljs-property">virtualAddress</span>, &#123;<br>    <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> comp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title class_">Object</span>(args[<span class="hljs-number">0</span>]);               <span class="hljs-comment">// this</span><br>        <span class="hljs-keyword">const</span> go = comp.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;get_gameObject&quot;</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_">invoke</span>();  <span class="hljs-comment">// 从对象上取方法再 invoke </span><br>        dbgComponentHandle = comp.<span class="hljs-property">handle</span>;<br>        dbgGameObjectHandle = go.<span class="hljs-property">handle</span>;<br>        <span class="hljs-keyword">let</span> name = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>          name = go.<span class="hljs-title function_">method</span>(<span class="hljs-string">&quot;get_name&quot;</span>, <span class="hljs-number">0</span>).<span class="hljs-title function_">invoke</span>()?.<span class="hljs-property">content</span> ?? <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (_) &#123;&#125;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Captured DebuggerComponent this =&quot;</span>, dbgComponentHandle);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Captured Debugger GameObject =&quot;</span>, dbgGameObjectHandle, <span class="hljs-string">&quot;name =&quot;</span>, name);<br>      &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[-] Failed to resolve DebuggerComponent.gameObject:&quot;</span>, e);<br>      &#125;<br>    &#125;<br>  &#125;);<br> <br>  <span class="hljs-comment">// 强制开启 + 查看谁在 disable DebuggerComponent</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking Behaviour.set_enabled @&quot;</span>, setEnabled.<span class="hljs-property">virtualAddress</span>);<br><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(setEnabled.<span class="hljs-property">virtualAddress</span>, &#123;<br>    <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-keyword">if</span> (dbgComponentHandle.<span class="hljs-title function_">isNull</span>()) <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">0</span>].<span class="hljs-title function_">equals</span>(dbgComponentHandle)) <span class="hljs-keyword">return</span>;<br><br>      <span class="hljs-keyword">if</span> (args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>() === <span class="hljs-number">0</span>) &#123;<br>        args[<span class="hljs-number">1</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] DebuggerComponent.enabled forced -&gt; true&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>          <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>            .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>            .<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;\n&quot;</span>)<br>        );<br>      &#125;<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-comment">// 强制开启 + 查看谁在 SetActive(false) Debugger 的 GameObject</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking GameObject.SetActive @&quot;</span>, setActive.<span class="hljs-property">virtualAddress</span>);<br><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(setActive.<span class="hljs-property">virtualAddress</span>, &#123;<br>    <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-keyword">if</span> (dbgGameObjectHandle.<span class="hljs-title function_">isNull</span>()) <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">0</span>].<span class="hljs-title function_">equals</span>(dbgGameObjectHandle)) <span class="hljs-keyword">return</span>;<br>      <span class="hljs-keyword">if</span> (args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>() === <span class="hljs-number">0</span>) &#123;<br>        args[<span class="hljs-number">1</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] Debugger GameObject SetActive(false) blocked&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>          <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>            .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>            .<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;\n&quot;</span>)<br>        );<br>      &#125;<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-comment">// 查看谁在 Destroy Debugger 相关对象</span><br>  <span class="hljs-keyword">if</span> (destroy) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooking Object.Destroy @&quot;</span>, destroy.<span class="hljs-property">virtualAddress</span>);<br><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(destroy.<span class="hljs-property">virtualAddress</span>, &#123;<br>      <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>) &#123;<br>        <span class="hljs-keyword">if</span> (dbgComponentHandle.<span class="hljs-title function_">isNull</span>() &amp;&amp; dbgGameObjectHandle.<span class="hljs-title function_">isNull</span>()) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">const</span> target = args[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (dbgComponentHandle.<span class="hljs-title function_">equals</span>(target) || dbgGameObjectHandle.<span class="hljs-title function_">equals</span>(target)) &#123;<br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] Destroy called on Debugger target =&quot;</span>, target);<br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>              .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>              .<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;\n&quot;</span>)<br>          );<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 按类名粗过滤一次</span><br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Il2Cpp</span>.<span class="hljs-title class_">Object</span>(target);<br>          <span class="hljs-keyword">const</span> k = obj.<span class="hljs-property">class</span>.<span class="hljs-property">fullName</span>;<br>          <span class="hljs-keyword">if</span> (k &amp;&amp; (k.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;Debugger&quot;</span>) || k.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;Wingjoy&quot;</span>))) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[!] Destroy:&quot;</span>, k, <span class="hljs-string">&quot;handle =&quot;</span>, target);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>              <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>                .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>                .<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;\n&quot;</span>)<br>            );<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (_) &#123;&#125;<br>      &#125;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[+] Hooks installed&quot;</span>);<br>&#125;);<br><br></code></pre></td></tr></table></figure>        </div>      </div>    </div><p>脚本执行LOG：</p><p><img src="/img/coderustle2/0x08-1.png"></p><p>实际效果：</p><p><img src="/img/coderustle2/0x08-2.png"></p><h3 id="0x09-其他已测试的修改点位"><a href="#0x09-其他已测试的修改点位" class="headerlink" title="0x09 其他已测试的修改点位"></a>0x09 其他已测试的修改点位</h3><p>1.提高装备爆率</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Token: 0x06001308 RID: 4872 RVA: 0x000AC8C4 File Offset: 0x000AAAC4</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NormalStageSettlement</span>(<span class="hljs-params">MapStageConfig mapStageConfig</span>)</span><br></code></pre></td></tr></table></figure><p>2.传奇宝石掉落时固定满级</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Token: 0x06002C7B RID: 11387 RVA: 0x0001D102 File Offset: 0x0001B302</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> LegendGem <span class="hljs-title">CreateLegendGem</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> level = <span class="hljs-number">1</span>, <span class="hljs-built_in">float</span> expPercentage = <span class="hljs-number">0f</span></span>)</span><br></code></pre></td></tr></table></figure><p>3.强化成功率100%</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// (get) Token: 0x060038D4 RID: 14548 RVA: 0x00024622 File Offset: 0x00022822</span><br><span class="hljs-keyword">public</span> ObscuredFloat UpgradeReformSuccessRate<br></code></pre></td></tr></table></figure><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Token: 0x04002970 RID: 10608</span><br><span class="hljs-keyword">public</span> ObscuredBool ReformSuccess = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// Token: 0x060027AB RID: 10155 RVA: 0x000199F8 File Offset: 0x00017BF8</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">GameManager</span>()</span><br></code></pre></td></tr></table></figure><p>4.托管战斗时结算界面时间缩短至1秒</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Token: 0x06002559 RID: 9561 RVA: 0x0012819C File Offset: 0x0012639C</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ShowResult</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> isEscape, <span class="hljs-built_in">bool</span> isWin, List&lt;RewardParam&gt; rewardParams, List&lt;RewardParam&gt; clearRewardParams, List&lt;RewardParam&gt; autoDecompose, WoodenStakeBattle woodenStakeBattle</span>)</span><br></code></pre></td></tr></table></figure><p>5.玩家受伤不扣血</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Token: 0x0400296D RID: 10605</span><br><span class="hljs-keyword">public</span> ObscuredBool Invincible = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// Token: 0x060027AB RID: 10155 RVA: 0x000199F8 File Offset: 0x00017BF8</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">GameManager</span>()</span><br></code></pre></td></tr></table></figure><p>6.免广告</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Wingjoy.CodeRustle.Manager.GameManager</span><br><span class="hljs-comment">// Token: 0x060027B0 RID: 10160 RVA: 0x00136E74 File Offset: 0x00135074</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">PlayRewardVideo</span>(<span class="hljs-params">AdsPlaceType adsPlaceType, Action callback</span>)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>MobileGame</tag>
      
      <tag>Unity</tag>
      
      <tag>HybridCLR</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
